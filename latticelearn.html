

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Constraint Lattice — Learning to Move (Novice → Expert)</title>
  <style>
    :root{
      --bg:#f7fafc;
      --text:#0f172a;
      --muted:#475569;
      --muted2:#64748b;
      --border:rgba(15,23,42,.12);
      --shadow: 0 14px 34px rgba(15,23,42,.10);
      --radius:16px;

      --edge:rgba(30,41,59,.16);
      --edgeHi:rgba(2,132,199,.85);

      --lvl0:#fff7ed;
      --lvl1:#eff6ff;
      --lvl2:#f5f3ff;
      --lvl3:#ecfeff;
      --lvl4:#f0fdf4;
      --lvl5:#f8fafc;
      --lvl6:#fff1f2;

      /* Journey visuals */
      --jPrimary: rgba(124,58,237,.92);
      --jGlow: rgba(124,58,237,.16);
      --jBorder: rgba(124,58,237,.26);
      --jTrack: rgba(15,23,42,.10);
      --jTrack2: rgba(15,23,42,.18);

      --focusStroke: rgba(2,132,199,.80);
      --focusGlow: rgba(2,132,199,.16);
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
      background:
        radial-gradient(900px 520px at 10% 10%, rgba(56,189,248,.20), transparent 60%),
        radial-gradient(900px 520px at 85% 10%, rgba(34,197,94,.18), transparent 55%),
        radial-gradient(900px 520px at 60% 100%, rgba(168,85,247,.14), transparent 55%),
        var(--bg);
      color:var(--text);
      overflow:hidden;
    }

    /* ====== FIXED TWO-COLUMN LAYOUT ======
       - RHS always fits and can shrink
       - min-width:0 so grid children can shrink (prevents overflow)
    */
    .layout{
      height: 100vh;
      display:grid;
      grid-template-columns: minmax(520px, 1fr) minmax(320px, 420px);
      gap:12px;
      padding:12px;
      min-height:0;
    }
    .leftCol, .panel{ min-width:0; }

    /* LEFT COLUMN is a vertical stack */
    .leftCol{
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    /* Timeline bar (ONLY above lattice, left side) */
    .timelineBar{
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      background:
        radial-gradient(520px 220px at 15% 15%, rgba(124,58,237,.12), transparent 55%),
        rgba(255,255,255,.88);
      backdrop-filter: blur(10px);
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      flex: 0 0 auto;
      overflow:hidden;
      min-width:0;
    }
    .timelineTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      min-width:0;
    }
    .timelineTop .left{
      display:flex; flex-direction:column; gap:2px;
      min-width: 220px;
      flex:1 1 auto;
    }
    .timelineTop .title{
      font-weight:950; font-size:12.5px; letter-spacing:.2px;
      display:flex; gap:8px; align-items:center;
    }
    .timelineTop .title .dot{
      width:10px; height:10px; border-radius:999px;
      background: var(--jPrimary);
      box-shadow: 0 0 0 4px rgba(124,58,237,.12);
      flex:0 0 auto;
    }
    .timelineTop .sub{
      font-size:12px; color:var(--muted2); line-height:1.35;
    }

    .btnRow{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;}
    .btn{
      appearance:none;
      border:1px solid var(--border);
      color:var(--text);
      background: rgba(15,23,42,.03);
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font-weight:900;
      font-size:12px;
      transition: transform .06s ease, background .12s ease, border-color .12s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{background: rgba(15,23,42,.06); border-color:rgba(15,23,42,.18)}
    .btn:active{transform: translateY(1px)}
    .btn.purple{background: rgba(124,58,237,.10); border-color: rgba(124,58,237,.24)}
    .btn.purple:hover{background: rgba(124,58,237,.14)}
    .btn:disabled{opacity:.55; cursor:not-allowed}

    .timeline{
      position:relative;
      display:flex;
      gap:8px;
      align-items:stretch;
      overflow:auto;
      padding:6px 4px 2px;
      scroll-snap-type:x mandatory;
    }
    .timeline::before{
      content:"";
      position:absolute;
      left:10px; right:10px;
      top:22px;
      height:2px;
      background: linear-gradient(90deg, var(--jTrack), var(--jTrack2), var(--jTrack));
      border-radius:999px;
      pointer-events:none;
    }

    /* Timeline cards are THINNER: remove subtitle line and tighten spacing */
    .tStep{
      scroll-snap-align:start;
      position:relative;
      min-width: 190px;
      max-width: 240px;
      border:1px solid var(--border);
      background: rgba(15,23,42,.02);
      border-radius: 16px;
      padding:8px 10px;
      cursor:pointer;
      user-select:none;
      transition: transform .06s ease, background .12s ease, border-color .12s ease, box-shadow .12s ease;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .tStep:hover{background: rgba(255,255,255,.96); border-color: rgba(15,23,42,.18)}
    .tStep:active{transform: translateY(1px)}
    .tStep.active{
      border-color: var(--jBorder);
      background: rgba(124,58,237,.06);
      box-shadow: 0 0 0 4px rgba(124,58,237,.10);
    }
    .tStep.done{
      border-color: rgba(15,23,42,.16);
      background: rgba(15,23,42,.02);
    }
    .tTop{
      display:flex; align-items:center; justify-content:space-between; gap:8px;
    }
    .tNum{
      width:22px; height:22px; border-radius:999px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(124,58,237,.10);
      border:1px solid rgba(124,58,237,.22);
      color: rgba(124,58,237,.95);
      font-weight:950; font-size:12px;
      flex:0 0 auto;
    }
    .tStep.done .tNum{
      background: rgba(15,23,42,.03);
      border-color: rgba(15,23,42,.14);
      color: rgba(15,23,42,.70);
    }
    .pill{
      font-size:11px; padding:5px 9px; border-radius:999px;
      border:1px solid rgba(15,23,42,.12);
      background: rgba(15,23,42,.03);
      color:var(--muted2);
      font-weight:900;
      white-space:nowrap;
    }
    .pill.purple{
      border-color: rgba(124,58,237,.22);
      background: rgba(124,58,237,.08);
      color: rgba(124,58,237,.95);
    }
    .tTitle{font-weight:950; font-size:12px; line-height:1.15}

    /* Lattice stage (fills remaining height in left column) */
    .stage{
      flex: 1 1 auto;
      min-height:0;
      position:relative;
      overflow:auto;
      border-radius: var(--radius);
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      background: rgba(255,255,255,.78);
    }
    .stageInner{
      position:relative;
      min-width:980px;
      padding:14px 14px 22px;
    }

    svg#edges{
      position:absolute; top:0; left:0;
      width:100%; height:100%;
      pointer-events:none;
      overflow:visible;
    }
    .edge{stroke: rgba(30,41,59,.16); stroke-width: 2; fill:none}
    .edge.hi{
      stroke: var(--edgeHi);
      stroke-width: 2.6;
      filter: drop-shadow(0 1px 0 rgba(2,132,199,.10));
    }
    .edge.stage{
      stroke: rgba(124,58,237,.85);
      stroke-width: 3.0;
      filter: drop-shadow(0 2px 0 rgba(124,58,237,.12));
    }
    .edge.dim{opacity:.18}

    .howto{
      border:1px solid rgba(124,58,237,.18);
      background: rgba(124,58,237,.06);
      border-radius: 16px;
      padding:10px 12px;
      margin-bottom:10px;
    }
    .howto .title{font-weight:950; font-size:13px; letter-spacing:.2px;}
    .howto .hint{font-size:12px; color:var(--muted2); line-height:1.35; margin-top:2px;}
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:11px; padding:2px 6px; border-radius:8px;
      border:1px solid var(--border);
      background: rgba(15,23,42,.03);
      color: var(--muted);
      white-space:nowrap;
    }

    /* Levels */
    .level{
      margin-top:10px;
      padding:12px;
      border-radius: 16px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.90);
    }
    .level:first-child{margin-top:0}
    .levelHeader{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-bottom:10px;
      flex-wrap:wrap;
    }
    .levelHeader .lhTitle{
      display:flex; align-items:center; gap:10px;
      font-weight:950; letter-spacing:.2px; font-size:13px;
    }
    .badge{
      font-size:11px; padding:5px 9px; border-radius:999px;
      background: rgba(15,23,42,.04);
      border:1px solid var(--border);
      color: var(--muted2);
      font-weight:950;
      letter-spacing:.2px;
      white-space:nowrap;
    }
    .lhHint{font-size:12px; color:var(--muted2)}
    .rowNodes{display:flex; flex-wrap:wrap; gap:10px; align-items:flex-start;}

    /* Nodes */
    .node{
      position:relative;
      border-radius:999px;
      padding:9px 12px;
      border:1px solid rgba(15,23,42,.14);
      background: rgba(255,255,255,.92);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      transition: transform .06s ease, background .12s ease, border-color .12s ease, box-shadow .12s ease, opacity .12s ease;
      font-size:12px;
      line-height:1;
      white-space:nowrap;
      touch-action: manipulation;
    }
    .node:hover{background:#fff; border-color:rgba(15,23,42,.22)}
    .node:active{transform: translateY(1px)}
    .node .dot{
      width:10px; height:10px; border-radius:999px;
      background: rgba(2,132,199,.9);
      box-shadow: 0 0 0 3px rgba(2,132,199,.12);
    }
    .node[data-kind="standard"] .dot{background: rgba(22,163,74,.9); box-shadow: 0 0 0 3px rgba(22,163,74,.12)}
    .node[data-kind="case"] .dot{background: rgba(234,88,12,.9); box-shadow: 0 0 0 3px rgba(234,88,12,.12)}
    .node[data-kind="risk"] .dot{background: rgba(225,29,72,.88); box-shadow: 0 0 0 3px rgba(225,29,72,.12)}
    .node[data-kind="wisdom"] .dot{background: rgba(124,45,18,.90); box-shadow: 0 0 0 3px rgba(124,45,18,.12)}

    .node[data-level="0"]{background: var(--lvl0); border-color: rgba(234,88,12,.22)}
    .node[data-level="1"]{background: var(--lvl1); border-color: rgba(37,99,235,.22)}
    .node[data-level="2"]{background: var(--lvl2); border-color: rgba(124,58,237,.20)}
    .node[data-level="3"]{background: var(--lvl3); border-color: rgba(6,182,212,.22)}
    .node[data-level="4"]{background: var(--lvl4); border-color: rgba(22,163,74,.22)}
    .node[data-level="5"]{background: var(--lvl5); border-color: rgba(15,23,42,.14)}
    .node[data-level="6"]{background: var(--lvl6); border-color: rgba(225,29,72,.18)}

    .node .tag{
      font-size:10px; padding:3px 7px; border-radius:999px;
      border:1px solid rgba(15,23,42,.14);
      background: rgba(255,255,255,.55);
      color: var(--muted2);
      font-weight:950;
      letter-spacing:.2px;
      white-space:nowrap;
    }

    .node.selected{
      border-color: var(--focusStroke);
      box-shadow: 0 0 0 5px var(--focusGlow);
    }

    /* Journey emphasis */
    .node.stageActive{
      border-color: rgba(124,58,237,.75) !important;
      box-shadow: 0 0 0 6px rgba(124,58,237,.14) !important;
    }
    .node.stageVisited{
      border-color: rgba(15,23,42,.26) !important;
      box-shadow: 0 0 0 4px rgba(15,23,42,.08) !important;
      opacity: .92;
    }
    .node.stageDim{
      opacity: .18;
      filter: saturate(.85);
    }

    /* RIGHT: full-height story sidebar with WORKING SCROLLBAR */
 /* Make the RHS panel scroll */
.panel{
  height: 100%;
  min-height: 0;          /* important in grid/flex */
  min-width: 0;
  display: flex;
  flex-direction: column;

  overflow-y: scroll;     /* force a visible vertical scrollbar */
  overflow-x: hidden;     /* no horizontal scroll */
  scrollbar-gutter: stable; /* keep space for the bar (supported in modern browsers) */
}

/* pbody becomes a normal wrapper (NOT the scroll container) */
.pbody{
  padding: 12px;
  overflow: visible;      /* important: remove the competing overflow */
  flex: 0 0 auto;
}
    .storyHero{
      border-radius: 18px;
      border:1px solid rgba(124,58,237,.20);
      background:
        radial-gradient(520px 220px at 15% 15%, rgba(124,58,237,.14), transparent 55%),
        radial-gradient(520px 220px at 85% 10%, rgba(56,189,248,.14), transparent 55%),
        rgba(255,255,255,.96);
      padding:12px;
      position:relative;
      overflow:hidden;
    }
    .storyHero .row1{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .badgeBig{
      display:inline-flex; gap:8px; align-items:center;
      font-weight:950; letter-spacing:.2px;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(124,58,237,.24);
      background: rgba(124,58,237,.08);
      color: rgba(124,58,237,.95);
      white-space:nowrap;
    }
    .badgeBig .spark{
      width:10px; height:10px; border-radius:999px;
      background: rgba(124,58,237,.92);
      box-shadow: 0 0 0 4px rgba(124,58,237,.14);
    }
    .storyHero .title{
      margin-top:8px;
      font-size:13.5px;
      font-weight:950;
      letter-spacing:.2px;
      line-height:1.25;
    }
    .storyHero .subtitle{
      margin-top:4px;
      font-size:12px;
      color: var(--muted2);
      line-height:1.4;
    }
    .chips{display:flex; gap:6px; flex-wrap:wrap; margin-top:10px}

    .sectionTitle{
      margin-top:12px;
      font-size:11px;
      color: var(--muted2);
      font-weight:950;
      letter-spacing:.18px;
      text-transform: uppercase;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .miniPill{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.70);
      color: var(--muted2);
      font-weight:900;
      white-space:nowrap;
    }
    .callout{
      border:1px solid rgba(15,23,42,.10);
      background: rgba(15,23,42,.02);
      border-radius: 16px;
      padding:10px;
      margin-top:8px;
      font-size:12.7px;
      line-height:1.5;
      color: rgba(15,23,42,.92);
    }
    .callout strong{font-weight:950}

    .grid2{
      display:grid;
      grid-template-columns: 1fr;
      gap:8px;
      margin-top:8px;
    }
    .qItem{
      border:1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.84);
      border-radius: 14px;
      padding:10px;
    }
    .qItem .q{
      font-weight:950;
      font-size:12.5px;
      line-height:1.35;
    }
    .qItem .why{
      margin-top:5px;
      font-size:12px;
      color: var(--muted2);
      line-height:1.35;
    }

    /* Toast */
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background: rgba(255,255,255,.95);
      border:1px solid var(--border);
      padding:10px 12px; border-radius: 14px;
      box-shadow: var(--shadow);
      font-size:12px;
      color: var(--text);
      opacity:0; pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index:40;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-4px)}

    @media (max-width: 1100px){
      body{overflow:auto}
      .layout{grid-template-columns: 1fr; height:auto}
      .leftCol{height:auto}
      .stage{height:70vh}
      .panel{height:auto; max-width:none; justify-self:stretch}
      .pbody{overflow:visible}
    }
  </style>
</head>

<body>
  <div class="layout">
    <!-- LEFT: timeline above lattice -->
    <section class="leftCol">
      <div class="timelineBar">
        <div class="timelineTop">
          <div class="left">
            <div class="title"><span class="dot"></span>Learning timeline</div>
            <div class="sub" id="stageCounter">Stage 1 / 9 • Procedural anchor</div>
          </div>
          <div class="btnRow">
            <button class="btn purple" id="btnPlay">Play</button>
            <button class="btn" id="btnPrev">Prev</button>
            <button class="btn" id="btnNext">Next</button>
          </div>
        </div>
        <div class="timeline" id="timeline"></div>
      </div>

      <main class="stage" id="stage">
        <div class="stageInner" id="stageInner">
          <svg id="edges" aria-hidden="true"></svg>

          <div class="howto">
            <div class="title">Constraint Lattice — learning as movement with coherence</div>
            <div class="hint">
              Purple highlights the staged learning path. Click lozenges for detail; multi-select:
              <span class="kbd">Shift+Click</span> or <span class="kbd">Long-press</span>. Clear selection: <span class="kbd">Esc</span>.
            </div>
          </div>

          <div id="levels"></div>
        </div>
      </main>
    </section>

    <!-- RIGHT: full-height story sidebar -->
    <aside class="panel">
      <div class="pbody">
        <div class="storyHero">
          <div class="row1">
            <div class="badgeBig"><span class="spark"></span><span id="storyStageName">Stage 1</span></div>
            <div class="pill purple" id="storyMode">Mode</div>
          </div>
          <div class="title" id="storyTitle"></div>
          <div class="subtitle" id="storySubtitle"></div>
          <div class="chips" id="storyTags"></div>

          <div class="sectionTitle">
            <span>Mindset</span>
            <span class="miniPill" id="storyWhere">Where they stand</span>
          </div>
          <div class="callout" id="storyMindset"></div>

          <div class="sectionTitle">
            <span>“What-if” questions</span>
            <span class="miniPill">Movement heuristic</span>
          </div>
          <div class="grid2" id="storyWhatIf"></div>

          <div class="sectionTitle">
            <span>Social environment</span>
            <span class="miniPill">Meetings & coordination</span>
          </div>
          <div class="callout" id="storySocial"></div>

          <div class="sectionTitle">
            <span>When the group is stuck</span>
            <span class="miniPill">Symptoms & escape move</span>
          </div>
          <div class="callout" id="storyStuck"></div>
        </div>
      </div>
    </aside>
  </div>

  <div class="toast" id="toast"></div>

<script>
/* =========================
   DATA (FULL)
   ========================= */
const DATA = {
  levels: [
    {id:0, title:"Management wisdom", hint:"Judgement-in-context: ethical, proportionate action under pressure"},
    {id:1, title:"Super-concepts", hint:"Big shaping ideas: why systems behave as they do"},
    {id:2, title:"Systems concepts", hint:"Core systems lenses and deep constraints"},
    {id:3, title:"System patterns", hint:"How systems behave (feedback, drift, work-as-done, coupling)"},
    {id:4, title:"OH management capabilities", hint:"Capabilities needed for a robust OH service"},
    {id:5, title:"Standards & improvement models", hint:"Formal frameworks and structured improvement"},
    {id:6, title:"Cases, challenges & pathologies", hint:"Concrete situations to trace back to roots"}
  ],
  nodes: [
    { id:"wis_listening", label:"Listening (serious attention)", level:0, kind:"wisdom", tags:["wisdom"], summary:"Listen for what isn’t in the dashboard: stories, tone, workarounds.", bodyHtml:`<p>Wise OH management listens beyond metrics: worker stories, near-miss narratives, complaint themes, and “unease”. Listening is a sensing practice that increases the system’s ability to self-regulate.</p><ul><li>Practice: short listening sessions + floor observation on peak days.</li></ul>`},
    { id:"wis_grace", label:"Grace (non-blame + dignity)", level:0, kind:"wisdom", tags:["wisdom"], summary:"Protect dignity; reduce shame; keep reporting safe.", bodyHtml:`<p>Grace means assuming people are trying to make the system work. Replace blame with curiosity about pressures, friction, and constraints. This preserves trust and keeps weak signals flowing.</p>`},
    { id:"wis_holism", label:"Holism (whole-system view)", level:0, kind:"wisdom", tags:["wisdom"], summary:"Don’t optimise one metric at the expense of health.", bodyHtml:`<p>Holism means seeing outcomes as emergent from interactions: people + tasks + tools + environment + rules/metrics + culture + external constraints.</p>`},
    { id:"wis_ecology", label:"Organisational ecology", level:0, kind:"wisdom", tags:["wisdom"], summary:"Systems have niches, diversity, interdependence and carrying capacity.", bodyHtml:`<p>An ecological lens asks: what “species” (roles) are missing? What resources constrain viability? What diversity provides resilience? What happens when keystone roles disappear (e.g., experienced supervisors)?</p>`},
    { id:"wis_embodiment", label:"Embodiment (body as system data)", level:0, kind:"wisdom", tags:["wisdom"], summary:"Fatigue, tension, moral discomfort are signals—not “soft stuff”.", bodyHtml:`<p>Embodied knowledge is real system sensing. Wise practice treats fatigue, overload, and discomfort as early warnings about work design and pressure, not personal weakness.</p>`},
    { id:"wis_proportion", label:"Proportion & timing", level:0, kind:"wisdom", tags:["wisdom"], summary:"Right-sized action; don’t flood the system with rules.", bodyHtml:`<p>Wise judgement chooses interventions that fit context and capacity. Over-control can increase workload and reduce compliance. Under-control lets drift grow.</p>`},
    { id:"wis_ethics", label:"Ethics & fairness", level:0, kind:"wisdom", tags:["wisdom"], summary:"Consent, confidentiality, dignity, and justice are design constraints.", bodyHtml:`<p>Ethics are not a “nice extra”—they are a structural constraint that stabilises trust, learning, and legitimacy.</p>`},
    { id:"wis_reflection", label:"Reflection & sensemaking", level:0, kind:"wisdom", tags:["wisdom"], summary:"Turn information into understanding before acting.", bodyHtml:`<p>Reflection converts data into meaning: check assumptions, look for pressures and adaptations, and avoid “compliance answers” that blame individuals.</p>`},
    { id:"wis_safe2fail", label:"Safe-to-fail experiments", level:0, kind:"wisdom", tags:["wisdom"], summary:"Test → learn → adapt in short cycles; prevent backfire.", bodyHtml:`<p>In complex systems you rarely “implement and finish”. You run small, ethical experiments with leading + lagging measures and explicit backfire checks.</p>`},

    { id:"ikww", label:"Information → Knowledge → Wisdom ladder", level:1, kind:"concept", tags:["meta"], summary:"More data ≠ better decisions; interpretation and judgement matter.", bodyHtml:`<p>Information is facts and documents. Knowledge is interpretation and patterns. Wisdom is good judgement in context: proportion, ethics, timing, and consequences.</p>`},
    { id:"sociotech", label:"Sociotechnical systems", level:1, kind:"concept", tags:["super"], summary:"Technical and social elements are inseparable.", bodyHtml:`<p>OH outcomes are produced by interactions among tools/tech, procedures, rosters, procurement, buildings, and social dynamics like power, trust, identity, and informal workarounds.</p>`},
    { id:"wai_wad", label:"Work-as-imagined vs work-as-done", level:1, kind:"concept", tags:["super"], summary:"Policies are simplified models; real work adapts under constraint.", bodyHtml:`<p>The gap is often the system trying to survive: people adapt to keep work moving. Wise interventions reduce friction and redesign conditions—not just remind people.</p>`},
    { id:"types_prob", label:"Problem types: simple / complicated / complex", level:1, kind:"concept", tags:["super"], summary:"Intervention choice should match problem type.", bodyHtml:`<p>Simple: repeatable fix. Complicated: expert engineered. Complex: adaptive/evolving; needs learning loops and safe-to-fail changes.</p>`},
    { id:"pressures_adapt", label:"Pressures → adaptations → outcomes", level:1, kind:"concept", tags:["super"], summary:"People adapt to pressure; adaptations shape risk.", bodyHtml:`<p>Map system pressures (scarcity, time, targets, contracts) and the adaptations people use (workarounds, skipping breaks, staging in hoods). These often explain why controls fail.</p>`},
    { id:"weak_signals", label:"Weak signals & “unease”", level:1, kind:"concept", tags:["super"], summary:"Small complaints and tone shifts can be early warnings.", bodyHtml:`<p>Examples: repeated glove size issues, narratives mentioning “no time”, silence (fewer reports because nothing changes). Treat these as signals to investigate work-as-done.</p>`},
    { id:"tech_more_data", label:"Technology: more data ≠ better decisions", level:1, kind:"concept", tags:["super"], summary:"Without interpretive capacity and ethics, data amplifies noise.", bodyHtml:`<p>Before adopting OH tech: clarify purpose, consent & dignity, interpretation ownership, feedback loop, unintended consequences.</p>`},
    { id:"seci", label:"SECI learning cycle", level:1, kind:"concept", tags:["learning"], summary:"Tacit ↔ explicit knowledge conversion (socialise, externalise, combine, internalise).", bodyHtml:`<p>Use SECI to turn experience into safer systems: observe work, create shared artefacts, update systems, practise until it becomes habit.</p>`},
    { id:"friction_audit", label:"Friction audit", level:1, kind:"concept", tags:["super"], summary:"Find where controls clash with real work (physical/workflow/social/system).", bodyHtml:`<p>Pick one control (PPE, LEV, break policy, reporting tool). Identify friction and redesign to remove it.</p>`},
    { id:"ecology_niches", label:"Ecology: niches, diversity, carrying capacity", level:1, kind:"concept", tags:["super"], summary:"Resource limits and missing roles reshape outcomes.", bodyHtml:`<p>Ask: what resources are scarce (time, attention, maintenance)? Which roles are keystone? What diversity provides resilience?</p>`},

    { id:"complexity", label:"Complexity", level:2, kind:"concept", tags:["systems"], summary:"Many interacting parts + uncertain cause/effect.", bodyHtml:`<p>Complexity grows with many interacting actors and delayed or indirect effects. Don’t “solve” by blaming individuals—design feedback and governance that works under change.</p>`},
    { id:"variety", label:"Variety", level:2, kind:"concept", tags:["systems"], summary:"The range of situations you must handle.", bodyHtml:`<p>If system response variety is lower than environmental variety, errors and dissatisfaction rise. Increase capability variety or reduce environmental variety via good design.</p>`},
    { id:"information", label:"Information", level:2, kind:"concept", tags:["systems"], summary:"Signals that enable decisions and coordination.", bodyHtml:`<p>Information flows coordinate action; poor information design creates breaches, rework, and hidden risk.</p>`},
    { id:"entropy", label:"Entropy / drift", level:2, kind:"concept", tags:["systems"], summary:"Processes degrade unless actively maintained.", bodyHtml:`<p>Process drift: templates stale, roles blur, temporary workarounds become normal, and risk quietly grows unless countered.</p>`},
    { id:"feedback", label:"Feedback loops", level:2, kind:"concept", tags:["systems"], summary:"Measure → learn → adapt.", bodyHtml:`<p>Good feedback loops keep you out of “surprise failure.” Use leading indicators, audit-reaudit, complaints learning, near-miss narratives.</p>`},
    { id:"boundaries", label:"System boundaries", level:2, kind:"concept", tags:["systems"], summary:"What’s inside vs outside the system.", bodyHtml:`<p>Boundary choices decide who is included in care and accountability: employees vs contractors, domestic vs overseas sites, primary provider vs subcontractors.</p>`},
    { id:"flow", label:"Flow (resources/time/data)", level:2, kind:"concept", tags:["systems"], summary:"Throughput, bottlenecks, and capacity constraints.", bodyHtml:`<p>Think of flow broadly: people, time, attention, data, money. Bottlenecks show up as waiting lists, rushed assessments, delayed corrective actions.</p>`},
    { id:"scale", label:"Scale & distribution", level:2, kind:"concept", tags:["systems"], summary:"What changes when systems get bigger or more distributed.", bodyHtml:`<p>At scale, interfaces multiply; central policy can fail locally and local workarounds fragment governance.</p>`},
    { id:"time_delays", label:"Delays & accumulation", level:2, kind:"concept", tags:["systems"], summary:"Effects lag causes; harm accumulates invisibly.", bodyHtml:`<p>Exposure → disease; stressors → absence; drift → incidents. Delays cause misattribution and “fixes” that don’t work.</p>`},
    { id:"coupling", label:"Coupling & cascades", level:2, kind:"concept", tags:["systems"], summary:"Tight coupling lets small failures propagate.", bodyHtml:`<p>Portals, SLAs, report routing, subcontracting: tight coupling amplifies small errors into bigger incidents and rework cascades.</p>`},
    { id:"resilience", label:"Resilience & slack", level:2, kind:"concept", tags:["systems"], summary:"Capacity to absorb spikes without unsafe adaptation.", bodyHtml:`<p>Resilience comes from margin: spare capacity, flexible capability, and adaptive coordination—not just procedures.</p>`},
    { id:"learning_memory", label:"Learning & institutional memory", level:2, kind:"concept", tags:["systems"], summary:"What the organisation remembers shapes outcomes.", bodyHtml:`<p>Turnover and restructuring erode “why we do it this way.” Without memory, drift accelerates and old failures repeat.</p>`},
    { id:"emergence", label:"Emergence", level:2, kind:"concept", tags:["systems"], summary:"Outcomes arise from interactions, not parts.", bodyHtml:`<p>Safety, culture, and service quality are emergent; you manage them by shaping interactions and constraints.</p>`},
    { id:"purpose_conflict", label:"Purpose & value conflicts", level:2, kind:"concept", tags:["systems"], summary:"OH is multi-purpose: care, risk control, fairness, compliance, productivity.", bodyHtml:`<p>Purpose conflicts drive downstream pathologies: speed vs consent; throughput vs recovery; cost vs competence; compliance vs learning.</p>`},
    { id:"power_incentives", label:"Power & incentives", level:2, kind:"concept", tags:["systems"], summary:"Commissioning and KPIs reshape behaviour.", bodyHtml:`<p>Many “quality” problems are incentive problems: the system optimises what hurts most (targets, costs, reputational risk), sometimes at the expense of health.</p>`},
    { id:"trust_legit", label:"Trust & legitimacy", level:2, kind:"concept", tags:["systems"], summary:"Without trust, signals disappear and learning collapses.", bodyHtml:`<p>Confidentiality, dignity and procedural fairness preserve trust and therefore sensing capacity.</p>`},
    { id:"uncertainty", label:"Uncertainty & model limits", level:2, kind:"concept", tags:["systems"], summary:"Prognosis and work capacity are uncertain; false certainty creates brittleness.", bodyHtml:`<p>Express uncertainty honestly (ranges, conditions). Design policies that tolerate variation and revise with feedback.</p>`},
    { id:"constraints_safety", label:"Safety as constraint control", level:2, kind:"concept", tags:["systems"], summary:"Safety is maintaining constraints, not just preventing component failures.", bodyHtml:`<p>Design constraints that keep outcomes within viable bounds under pressure (work-as-done). This fits naturally with a constraint lattice.</p>`},

    { id:"control", label:"Control & constraints", level:3, kind:"concept", tags:["patterns"], summary:"Rules and controls that shape behaviour under real conditions.", bodyHtml:`<p>Controls range from elimination/design to training and PPE. The point is to constrain unsafe outcomes reliably under real conditions.</p>`},
    { id:"interfaces", label:"Interfaces & handoffs", level:3, kind:"concept", tags:["patterns"], summary:"Where errors and misalignment cluster.", bodyHtml:`<p>Interfaces (portals, referral forms, report delivery, dashboards) are common failure points: wrong recipients, missing fields, ambiguous requests.</p>`},
    { id:"governanceInfo", label:"Information governance", level:3, kind:"concept", tags:["patterns"], summary:"Confidentiality, consent, security, retention.", bodyHtml:`<p>Information governance includes informed consent pathways, access control, secure storage, backups, and safe aggregation.</p>`},
    { id:"supplyChains", label:"Supply chains & accountability", level:3, kind:"concept", tags:["patterns"], summary:"Outsourcing creates chains; accountability must stay clear.", bodyHtml:`<p>Subcontracting can create chains. Quality assurance and accountability must be explicit—otherwise oversight and learning fail.</p>`},
    { id:"measurementVar", label:"Measurement & variation", level:3, kind:"concept", tags:["patterns"], summary:"Distinguish noise vs signals; avoid punishing reporting.", bodyHtml:`<p>Choose indicators that reveal drift (run/control charts) and avoid metrics that punish honest reporting.</p>`},
    { id:"processDrift", label:"Normalization of deviance", level:3, kind:"risk", tags:["pathology"], summary:"Workarounds become ‘normal’ under pressure.", bodyHtml:`<p>Under production pressure, unsafe shortcuts become routine unless the system detects and corrects them.</p>`},
    { id:"weakSignalsLoop", label:"Early warning loop", level:3, kind:"concept", tags:["patterns"], summary:"Capture weak signals → interpret → act → learn.", bodyHtml:`<p>Design escalation signals that cut through noise: near-miss narratives, recurring complaints, unusual workload patterns, “unease”.</p>`},
    { id:"audit_as_feedback", label:"Audit as feedback (not ritual)", level:3, kind:"concept", tags:["patterns"], summary:"Audit is valuable only if it increases sensing and regulation.", bodyHtml:`<p>Audit becomes noise when treated as a ritual of compliance rather than a learning loop. Wise audit strengthens learning loops and adapts the system.</p>`},
    { id:"work_design", label:"Work design & friction", level:3, kind:"concept", tags:["patterns"], summary:"Controls fail when they clash with real work; remove friction.", bodyHtml:`<p>Look for physical, workflow, social, and system friction that pushes unsafe adaptation.</p>`},

    { id:"relationships", label:"Multi-party relationship", level:4, kind:"concept", tags:["OH"], summary:"Employee–Employer–OH provider + others.", bodyHtml:`<p>OH operates in multiple simultaneous relationships and must manage consent, contract expectations, and trust.</p>`},
    { id:"commissioning", label:"Commissioning & scope clarity", level:4, kind:"concept", tags:["OH"], summary:"What is included/excluded; referral pathways.", bodyHtml:`<p>Clarity about inclusions/exclusions and referral pathways prevents dissatisfaction and risk. Specify QA and oversight when subcontracting.</p>`},
    { id:"consent", label:"Consent & confidentiality", level:4, kind:"concept", tags:["OH"], summary:"Work-focused advice + consent for clinical detail.", bodyHtml:`<p>Employees must be informed about what is being asked, why, who will receive information, and their rights. Provide functional advice; disclose identifiable medical detail only with informed consent.</p>`},
    { id:"reports", label:"High-value OH reports", level:4, kind:"concept", tags:["OH"], summary:"Clear, justifiable, concise; avoid false precision.", bodyHtml:`<ul><li>Answer the question asked</li><li>Functional implications + options</li><li>Adjustments and rehab options</li><li>Timescales as ranges where appropriate</li><li>Secure handling + consent pathway</li></ul>`},
    { id:"audit", label:"Audit & improvement loop", level:4, kind:"concept", tags:["quality"], summary:"Pick topic → standard → measure → act → re-audit.", bodyHtml:`<ol><li>Pick a topic (risk/volume/cost/variation/complaints)</li><li>Define criteria + standard</li><li>Collect data</li><li>Feedback + actions</li><li>Implement change</li><li>Re-audit</li></ol>`},
    { id:"indicators", label:"Indicators (leading/lagging)", level:4, kind:"concept", tags:["quality"], summary:"Indicators that support prevention and learning.", bodyHtml:`<p>Use both leading (break reliability, glove availability) and lagging (dermatitis cases, absence) indicators. Avoid punishment signals that suppress reporting.</p>`},
    { id:"staffGov", label:"Staff governance & competence", level:4, kind:"concept", tags:["OH"], summary:"SOPs, supervision, CPD, audit, confidentiality training.", bodyHtml:`<p>Competence and supervision are reliability controls—especially across outsourcing chains.</p>`},
    { id:"surveillance", label:"Health surveillance design", level:4, kind:"concept", tags:["OH"], summary:"Hazard → method → competence → action triggers.", bodyHtml:`<p>Surveillance must match hazard and method; ensure competence, calibration, and follow-up triggers.</p>`},

    { id:"haccp", label:"HACCP (7 principles)", level:4, kind:"concept", tags:["food"], summary:"Hazards → CCPs → limits → monitoring → corrective actions → verification → records.", bodyHtml:`<p>HACCP is a practical system for preventing food-borne harm by identifying critical control points and defining monitoring and corrective actions.</p>`},
    { id:"danger_zone", label:"Danger zone (5°C–63°C) control", level:4, kind:"concept", tags:["food","flow"], summary:"Time–temperature control is a key outbreak prevention lever.", bodyHtml:`<p>Audit the real process: delivery → storage → prep → processing → transport → service. Focus on cooling, holding, reheating and high-risk foods.</p>`},
    { id:"contamination", label:"Contamination & allergen controls", level:4, kind:"concept", tags:["food"], summary:"Separation, hygiene, cleaning, pest control; prevent cross-contamination.", bodyHtml:`<p>Map contamination routes: people, surfaces, equipment, pests, storage. Build controls that still work on busy days.</p>`},
    { id:"food_ratings", label:"Food hygiene ratings as public signal", level:4, kind:"concept", tags:["food","signal"], summary:"External transparency that pressures improvement.", bodyHtml:`<p>Public ratings create strong incentives; ensure incentives don’t become “paperwork theatre” that ignores work-as-done.</p>`},
    { id:"acc_triangle", label:"Accident triangle / near-miss logic", level:4, kind:"concept", tags:["safety"], summary:"Near-misses and minor events are early warnings.", bodyHtml:`<p>Investigate near-miss narratives proactively; treat them as system signals, not personal failures.</p>`},
    { id:"riddor", label:"RIDDOR-style reporting & under-reporting", level:4, kind:"concept", tags:["safety"], summary:"Definitions matter; under-reporting kills learning.", bodyHtml:`<p>Reporting systems must protect dignity and avoid punishment. Otherwise signals vanish and risk grows silently.</p>`},
    { id:"metrics_safety", label:"Safety metrics (incidence/frequency/lost-day)", level:4, kind:"concept", tags:["safety","measurement"], summary:"Rates depend on denominators; look for variation and drift.", bodyHtml:`<p>Use measures as learning tools, not as weapons. Combine with narratives and observation.</p>`},
    { id:"cost_iceberg", label:"Cost iceberg (direct/indirect)", level:4, kind:"concept", tags:["safety","economics"], summary:"Many costs are hidden: downtime, rework, morale, reputation.", bodyHtml:`<p>Costs are feedback signals. Don’t let accounting visibility distort what gets fixed.</p>`},
    { id:"rca", label:"Immediate vs root causes", level:4, kind:"concept", tags:["safety"], summary:"Unsafe act/condition vs systemic drivers.", bodyHtml:`<p>Root causes often sit in procurement, maintenance, staffing, supervision, KPI conflicts and normalised deviance.</p>`},
    { id:"audit_tools7", label:"Seven quality tools", level:4, kind:"concept", tags:["audit"], summary:"Flowchart, check sheet, run/control chart, histogram, Pareto, fishbone, scatter.", bodyHtml:`<p>Choose tools that turn data into learning: e.g., Pareto for main failure modes, fishbone for causes, control charts for drift.</p>`},

    { id:"seqohs", label:"SEQOHS (UK OH service standard)", level:5, kind:"standard", tags:["standard"], summary:"Quality and governance domains for OH services.", bodyHtml:`<p>Domains include business probity, information governance, people/competence, facilities/equipment, purchaser relationships, worker relationships.</p>`},
    { id:"iso45001", label:"ISO 45001 (OHSMS)", level:5, kind:"standard", tags:["standard"], summary:"Framework for occupational health & safety management systems.", bodyHtml:`<p>Supports structured management of safety and health responsibilities with continual improvement.</p>`},
    { id:"hsg65", label:"HSG65 (HSE guidance)", level:5, kind:"standard", tags:["standard"], summary:"Plan–Do–Check–Act safety management guidance.", bodyHtml:`<p>Policy, organisation, planning, implementing, monitoring, audit & review.</p>`},
    { id:"iso9001", label:"ISO 9001 (QMS)", level:5, kind:"standard", tags:["standard"], summary:"Audit-able quality management system standard.", bodyHtml:`<p>Widely adopted; structures auditing against defined processes.</p>`},
    { id:"efqm", label:"EFQM Excellence (RADAR)", level:5, kind:"standard", tags:["model"], summary:"Results–Approach–Deploy–Assess–Refine.", bodyHtml:`<p>Self-assessment model useful for benchmarking and improvement.</p>`},
    { id:"tqm", label:"Total Quality Management (TQM)", level:5, kind:"standard", tags:["model"], summary:"Organisation-wide continuous improvement.", bodyHtml:`<p>Staff involvement + continuous improvement + process focus.</p>`},
    { id:"dmaic", label:"Six Sigma (DMAIC)", level:5, kind:"standard", tags:["model"], summary:"Define–Measure–Analyse–Improve–Control.", bodyHtml:`<p>Structured method for reducing defects and variation.</p>`},
    { id:"belbin", label:"Team roles (e.g., Belbin)", level:5, kind:"standard", tags:["model"], summary:"Role balance affects service reliability and coordination.", bodyHtml:`<p>Use team-role lenses to check whether coordination, finishing, specialist knowledge and implementation are sufficiently covered.</p>`},

    { id:"challenge_outsourcing", label:"Challenge: Outsourcing OH", level:6, kind:"risk", tags:["risk"], summary:"Supply chains + accountability + QA must be explicit.", bodyHtml:`<p>Outsourcing can help where internal demand is small/diverse, but commissioning employers remain responsible for duty of care. Contracts must specify QA, supervision, audit, and accountability across subcontractors.</p>`},
    { id:"case_subcontractor_failure", label:"Case: Subcontractor quality failure", level:6, kind:"case", tags:["case"], summary:"Missed report elements → complaints and risk.", bodyHtml:`<p>A subcontracted clinician repeatedly misses required elements in reports, creating complaints and risk. Design contract oversight, supervision, audit and remediation without breaking continuity.</p>`},
    { id:"case_wrong_report", label:"Case: Report sent to wrong person", level:6, kind:"case", tags:["case"], summary:"Data breach at an interface; root cause + prevention.", bodyHtml:`<p>A worker receives another employee’s OH report by mistake. Investigate the interface failure, fix verification and secure delivery, and improve governance.</p>`},
    { id:"case_employer_owns", label:"Case: “We pay, so we own the report”", level:6, kind:"case", tags:["case"], summary:"Manager demands full disclosure of what employee said.", bodyHtml:`<p>Respond with confidentiality principles: provide work-focused functional advice; obtain informed consent for medical details.</p>`},
    { id:"risk_underreporting", label:"Pathology: under-reporting & weak signals", level:6, kind:"risk", tags:["risk"], summary:"When reporting is punished, learning collapses.", bodyHtml:`<p>Under-reporting stems from fear, blame, lack of recognition and low trust. Signals vanish, risk grows silently.</p>`},
    { id:"risk_restructure_memory", label:"Pathology: restructuring erodes safety memory", level:6, kind:"risk", tags:["risk"], summary:"Roles blur; permits/reporting/training degrade.", bodyHtml:`<p>Restructuring can unintentionally harm safety by removing clear responsibilities, reducing inspection/training, and eroding “why” memory.</p>`},
    { id:"case_dermatitis_audit", label:"Case: Audit scores rose; dermatitis got worse", level:6, kind:"case", tags:["case"], summary:"Compliance theatre vs work-as-done reality.", bodyHtml:`<p>A new cleaning chemical arrives with SDS, training and gloves. Audit shows “good compliance”. Dermatitis rises. Wise analysis looks for pressure, stock-outs, onboarding gaps, KPI conflicts and friction—and redesigns the system.</p>`},
    { id:"case_lev_spikes", label:"Case: LEV passes; exposures persist on busy days", level:6, kind:"case", tags:["case"], summary:"Work-as-imagined vs work-as-done mismatch.", bodyHtml:`<p>LEV meets tests, but exposure spikes occur on high-throughput days. Fix friction: staging, tools, maintenance SLAs, KPI alignment and leading indicators under load.</p>`},
    { id:"case_food_cooling", label:"Case: Cooling failure in a busy kitchen", level:6, kind:"case", tags:["case","food"], summary:"Danger zone time accumulates during demand surges.", bodyHtml:`<p>Food spends too long between 5°C and 63°C during demand surges. Trace flow bottlenecks, redesign cooling workflow, add verification and “safe-to-fail” checks.</p>`}
  ],
  edges: (function(){
    return [
      {from:"wis_listening", to:"weak_signals", why:"Listening increases detection of weak signals and early warnings."},
      {from:"wis_embodiment", to:"weak_signals", why:"Embodied unease and fatigue are system signals worth attending to."},
      {from:"wis_holism", to:"sociotech", why:"Holism aligns with a sociotechnical view of work."},
      {from:"wis_reflection", to:"ikww", why:"Reflection converts information into understanding and wise action."},
      {from:"wis_safe2fail", to:"types_prob", why:"Safe-to-fail cycles fit complex problems better than big rollouts."},
      {from:"wis_grace", to:"weak_signals", why:"Non-blame climates keep reporting safe and signals flowing."},
      {from:"wis_ethics", to:"tech_more_data", why:"Ethical judgement constrains how monitoring and data are used."},
      {from:"wis_ecology", to:"ecology_niches", why:"Ecological thinking highlights roles, resources and resilience in organisations."},
      {from:"wis_proportion", to:"types_prob", why:"Proportionate action depends on recognising problem type and capacity."},

      {from:"ikww", to:"information", why:"Information is the base; but must be interpreted and judged."},
      {from:"ikww", to:"uncertainty", why:"Wisdom includes acknowledging uncertainty and avoiding false precision."},
      {from:"sociotech", to:"emergence", why:"Sociotechnical interactions produce emergent outcomes like safety and culture."},
      {from:"wai_wad", to:"entropy", why:"Workarounds become normal; drift grows unless countered."},
      {from:"wai_wad", to:"constraints_safety", why:"Safety depends on constraints that work for work-as-done."},
      {from:"types_prob", to:"complexity", why:"Complex problems have shifting interactions and require learning loops."},
      {from:"pressures_adapt", to:"flow", why:"Pressure often comes from bottlenecks, throughput and resource flow."},
      {from:"pressures_adapt", to:"power_incentives", why:"Targets and incentives shape what adaptations occur."},
      {from:"weak_signals", to:"feedback", why:"Weak signals are inputs to feedback loops."},
      {from:"tech_more_data", to:"information", why:"Tech increases information; value depends on interpretation and governance."},
      {from:"tech_more_data", to:"trust_legit", why:"Monitoring without dignity and consent destroys trust and learning."},
      {from:"seci", to:"learning_memory", why:"SECI explains how organisations renew memory and competence."},
      {from:"friction_audit", to:"constraints_safety", why:"Reducing friction helps controls hold under pressure."},
      {from:"ecology_niches", to:"resilience", why:"Diversity and keystone roles influence resilience and capacity."},
      {from:"ecology_niches", to:"scale", why:"At scale, ecology shifts: new interfaces and resource constraints appear."},

      {from:"complexity", to:"interfaces", why:"More actors and handoffs → more interface failure modes."},
      {from:"information", to:"interfaces", why:"Information structure determines handoff reliability."},
      {from:"information", to:"governanceInfo", why:"Sensitive information needs consent + security constraints."},
      {from:"entropy", to:"processDrift", why:"Without maintenance, drift becomes normalised deviance."},
      {from:"feedback", to:"measurementVar", why:"Feedback needs measurement; measurement must preserve learning."},
      {from:"feedback", to:"audit_as_feedback", why:"Audit is a formal feedback mechanism when used for learning."},
      {from:"boundaries", to:"supplyChains", why:"Boundary choices define accountability across outsourcing."},
      {from:"scale", to:"supplyChains", why:"More sites/providers → accountability and oversight become harder."},
      {from:"flow", to:"work_design", why:"Throughput pressure increases friction and pushes unsafe adaptations."},
      {from:"time_delays", to:"audit_as_feedback", why:"Delays mean you need leading indicators and frequent learning loops."},
      {from:"coupling", to:"interfaces", why:"Tight coupling makes handoff failures propagate quickly."},
      {from:"learning_memory", to:"weakSignalsLoop", why:"Learning systems institutionalise weak signals and prevent repeat failures."},
      {from:"trust_legit", to:"weakSignalsLoop", why:"Trust is required for honest reporting of weak signals."},
      {from:"purpose_conflict", to:"audit_as_feedback", why:"If audit is used as punishment, it becomes ritual and noise."},
      {from:"power_incentives", to:"measurementVar", why:"Metrics can create perverse incentives and under-reporting."},
      {from:"constraints_safety", to:"control", why:"Safety is implemented through constraint-based controls that hold under load."},

      {from:"interfaces", to:"reports", why:"Report delivery is a critical interface; design prevents mis-send and ambiguity."},
      {from:"governanceInfo", to:"consent", why:"Consent/confidentiality are how governance is enacted day-to-day."},
      {from:"supplyChains", to:"commissioning", why:"Contracts set QA and accountability across chains."},
      {from:"audit_as_feedback", to:"audit", why:"Audit loops translate feedback into system change and re-audit."},
      {from:"measurementVar", to:"indicators", why:"Indicators translate variation into actionable signals."},
      {from:"control", to:"surveillance", why:"Surveillance detects harm early and supports control reliability."},
      {from:"control", to:"staffGov", why:"Competence and SOPs are ‘human system’ controls for reliability."},
      {from:"sociotech", to:"relationships", why:"OH is embedded in social + technical relationships and incentives."},
      {from:"work_design", to:"danger_zone", why:"Food safety failures often arise from flow pressure and friction in real work."},
      {from:"weakSignalsLoop", to:"acc_triangle", why:"Near-miss narratives are early warnings that need interpretation and action."},
      {from:"measurementVar", to:"riddor", why:"Punitive reporting regimes create under-reporting; design matters."},
      {from:"feedback", to:"audit_tools7", why:"Quality tools help convert data into learning and action."},
      {from:"flow", to:"danger_zone", why:"Time–temperature control is a flow constraint with bottlenecks and surges."},
      {from:"constraints_safety", to:"haccp", why:"HACCP is a constraint-based control system with monitoring and corrective action."},

      {from:"commissioning", to:"seqohs", why:"SEQOHS constrains purchaser relationships and probity (including outsourced work)."},
      {from:"consent", to:"seqohs", why:"SEQOHS information governance and worker relationships constrain consent practice."},
      {from:"staffGov", to:"seqohs", why:"SEQOHS people domain aligns competence, supervision and CPD."},
      {from:"surveillance", to:"iso45001", why:"OHSMS expects hazard control and monitoring."},
      {from:"control", to:"hsg65", why:"HSG65 expresses policy/organisation/planning/monitoring/audit."},
      {from:"audit", to:"iso9001", why:"QMS structures auditing against defined processes."},
      {from:"audit", to:"tqm", why:"TQM embeds continuous improvement across the organisation."},
      {from:"audit", to:"dmaic", why:"DMAIC provides structured improvement (define-measure-analyse-improve-control)."},
      {from:"relationships", to:"belbin", why:"Team-role balance affects coordination, quality and stakeholder alignment."},

      {from:"commissioning", to:"challenge_outsourcing", why:"Outsourcing needs explicit scope, QA, and accountability terms."},
      {from:"supplyChains", to:"challenge_outsourcing", why:"Outsourcing creates chains; oversight must be designed."},
      {from:"challenge_outsourcing", to:"case_subcontractor_failure", why:"Subcontractor quality failure is a common chain breakdown mode."},
      {from:"interfaces", to:"case_wrong_report", why:"Handoff failure can cause data breach; fix interface design."},
      {from:"consent", to:"case_employer_owns", why:"Confidentiality + consent resolve the “we pay so we own it” bind."},
      {from:"measurementVar", to:"risk_underreporting", why:"Punitive metrics suppress reporting; signals disappear."},
      {from:"learning_memory", to:"risk_restructure_memory", why:"Restructures erode institutional memory and role clarity."},
      {from:"audit_as_feedback", to:"case_dermatitis_audit", why:"Audit must detect drift and pressure, not just paperwork compliance."},
      {from:"wai_wad", to:"case_lev_spikes", why:"Exposure spikes reveal work-as-done mismatch under high throughput."},
      {from:"danger_zone", to:"case_food_cooling", why:"Cooling/holding failures emerge from surge pressure and weak verification."},

      {from:"wis_listening", to:"case_dermatitis_audit", why:"Listening finds friction and supply/staffing realities that audits miss."},
      {from:"wis_safe2fail", to:"case_food_cooling", why:"Pilot small workflow changes with measures to prevent backfire."},
      {from:"wis_grace", to:"risk_underreporting", why:"Non-blame climates reduce fear and restore reporting signals."}
    ];
  })()
};

let data = structuredClone(DATA);

/* =========================
   JOURNEY (FULL)
   ========================= */
const JOURNEY = [
  {
    id:"s1",
    mode:"Procedural anchor",
    title:"Stage 1 — Novice: “Just tell me the rule”",
    subtitle:"Coherence depends on familiar procedures; novelty causes freeze or flailing.",
    where:"Mostly Level 5 (standards) + templates",
    tags:["compliance", "templates", "local certainty"],
    focus:"iso45001",
    highlight:["iso45001","hsg65","seqohs","audit","reports","consent"],
    traceFor:["reports","audit","consent"],
    mindsetHtml:`<strong>Attention is narrow.</strong> Procedures are treated as reality, not as models. When the checklist doesn’t fit, articulation collapses into either defensiveness or vague hand-waving.`,
    whatIf:[
      {q:"What if we follow the process perfectly but harm still happens?", why:"Forces an upward move: procedures are constraints, not guarantees."},
      {q:"What if workload spikes and the template becomes the bottleneck?", why:"Introduces flow/pressure and adaptive workarounds."},
      {q:"What if people stop reporting problems—how would we notice?", why:"Points to weak signals and trust as sensing capacity."}
    ],
    socialHtml:`Meetings reward certainty and speed. People ask for “the right answer” and polish policy wording. The group stays at compliance level (“did we do it?”) rather than viability (“did it hold under load?”).`,
    stuckHtml:`<strong>Stuck pattern:</strong> debating policy language while failure is happening at a handoff. <strong>Escape move:</strong> “Show me the interface where this breaks in work-as-done.”`
  },
  {
    id:"s2",
    mode:"Patterns & reliability",
    title:"Stage 2 — Early competence: “Where do failures cluster?”",
    subtitle:"Learner stabilises coherence by naming recurring breakdown shapes (handoffs, friction).",
    where:"Level 3 (patterns): interfaces, governance, friction",
    tags:["handoffs", "reliability", "error-shapes"],
    focus:"interfaces",
    highlight:["interfaces","governanceInfo","work_design","audit_as_feedback","measurementVar","reports","consent"],
    traceFor:["interfaces","audit_as_feedback"],
    mindsetHtml:`<strong>Attention widens.</strong> The learner stops hunting perfect rules and instead maps recurring failure modes: routing, ambiguity, verification gaps, and friction-triggered workarounds.`,
    whatIf:[
      {q:"What if the report is ‘correct’ but delivered to the wrong recipient?", why:"Makes the interface itself the constraint, not just the document."},
      {q:"What if we add control steps—do we create friction and new workarounds?", why:"Prevents over-control backfiring."},
      {q:"What if audit becomes theatre—what would real regulation look like?", why:"Shifts audit from ritual to feedback."}
    ],
    socialHtml:`Meetings become less personal. People bring artefacts (screenshots, routing diagrams), and coordination improves because there is a shared object everyone can point at.`,
    stuckHtml:`<strong>Stuck pattern:</strong> looping on “who messed up?” <strong>Escape move:</strong> “What did the system make easy/hard at the moment of action?”`
  },
  {
    id:"s3",
    mode:"Sensing & early warning",
    title:"Stage 3 — Developing: “Notice weak signals before harm”",
    subtitle:"Learner makes reporting safe and treats silence as a signal.",
    where:"Level 1↔3: weak signals + early warning loops",
    tags:["weak signals", "trust", "sensing"],
    focus:"weak_signals",
    highlight:["weak_signals","wis_listening","wis_grace","trust_legit","weakSignalsLoop","measurementVar"],
    traceFor:["weakSignalsLoop","trust_legit"],
    mindsetHtml:`<strong>Attention becomes diagnostic.</strong> The learner can say, “absence of signals is also a signal.” Coherence comes from a stable sensing story: what we hear, what’s missing, and what it implies.`,
    whatIf:[
      {q:"What if reporting drops—improvement or fear?", why:"Trust is a hard constraint on sensing."},
      {q:"What if shame rises—what information stops flowing?", why:"Links dignity to organisational learning capacity."},
      {q:"What if metrics punish honesty—what will drift look like?", why:"Connects measurement to behaviour."}
    ],
    socialHtml:`Leaders learn to reward candour. Meetings include short narratives (“what was hard this week?”) alongside metrics. The group learns to hold discomfort without blame.`,
    stuckHtml:`<strong>Stuck pattern:</strong> “We need more data” as avoidance. <strong>Escape move:</strong> “What would we do differently if the data arrived? Let’s run a safe-to-fail probe.”`
  },
  {
    id:"s4",
    mode:"Pressure → adaptation",
    title:"Stage 4 — Competent: “Pressure creates rational shortcuts”",
    subtitle:"Learner keeps coherence by tracing pressures → adaptations → outcomes.",
    where:"Level 1↔2: pressures, incentives, flow",
    tags:["pressure", "adaptation", "throughput"],
    focus:"pressures_adapt",
    highlight:["pressures_adapt","flow","power_incentives","wai_wad","work_design","constraints_safety"],
    traceFor:["flow","constraints_safety"],
    mindsetHtml:`<strong>Cause and effect becomes conditional.</strong> The learner stops searching for single causes and explains “why this adaptation was rational.” They can move up/down and keep the narrative coherent.`,
    whatIf:[
      {q:"What if throughput targets increase—what shortcuts become rational?", why:"Shows how incentives reshape behaviour."},
      {q:"What if we remove slack—where does risk reappear?", why:"Resilience becomes visible as capacity, not luxury."},
      {q:"What if work-as-imagined diverges—how do we see it on a busy day?", why:"Anchors learning in WAD observation."}
    ],
    socialHtml:`Meetings become multi-perspective: ops names constraints, frontline names workarounds, OH names harm mechanisms. Shared language appears: pressure, friction, adaptation, drift.`,
    stuckHtml:`<strong>Stuck pattern:</strong> policy vs practice argument (both “right”). <strong>Escape move:</strong> “Climb: system pressure → local adaptation → what must hold.”`
  },
  {
    id:"s5",
    mode:"Uncertainty & delays",
    title:"Stage 5 — Systems thinker: “Effects lag; drift is quiet”",
    subtitle:"Learner designs leading indicators and avoids false precision.",
    where:"Level 2: uncertainty, delays, feedback",
    tags:["delays", "drift", "leading indicators"],
    focus:"time_delays",
    highlight:["uncertainty","time_delays","entropy","feedback","audit_as_feedback","learning_memory"],
    traceFor:["feedback","audit_as_feedback"],
    mindsetHtml:`<strong>Comfort with “not yet known”.</strong> The learner replaces false certainty with ranges and conditions. Coherence comes from a feedback plan: expectations, signals, actions.`,
    whatIf:[
      {q:"What if the real effect appears months later—what do we watch now?", why:"Forces leading indicators and monitoring design."},
      {q:"What if processes drift slowly—how do we detect early?", why:"Connects entropy to audit-as-feedback."},
      {q:"What if our fix shifts risk elsewhere—what backfire checks?", why:"Stabilises experimentation."}
    ],
    socialHtml:`Meetings shift from “who is right?” to “what will we monitor?” People stop performing certainty and start performing learning.`,
    stuckHtml:`<strong>Stuck pattern:</strong> “We can’t act until we’re sure.” <strong>Escape move:</strong> “What’s the smallest reversible action that teaches us?”`
  },
  {
    id:"s6",
    mode:"Constraint design",
    title:"Stage 6 — Constraint engineer: “What must hold under load?”",
    subtitle:"Learner designs constraints that survive busy days, turnover, and coupling.",
    where:"Level 2↔3: constraints_safety → control/work design",
    tags:["constraints", "robustness", "work design"],
    focus:"constraints_safety",
    highlight:["constraints_safety","control","work_design","interfaces","resilience","coupling"],
    traceFor:["control","work_design"],
    mindsetHtml:`<strong>Thinking becomes architectural.</strong> The learner asks: “Where should the constraint bite?” and designs for load, not ideal conditions—anticipating cascades across interfaces.`,
    whatIf:[
      {q:"What if a small failure propagates—where are we tightly coupled?", why:"Prevents cascade surprises."},
      {q:"What if we add steps—do we overload the system and create new risk?", why:"Keeps constraints proportionate."},
      {q:"What if competence varies across sites—how do we stay coherent?", why:"Brings scale/distribution into view."}
    ],
    socialHtml:`Meetings include “busy day simulations.” Disagreements are resolved by testing constraints under stress, not by authority alone.`,
    stuckHtml:`<strong>Stuck pattern:</strong> endless best-practice debate without contact with real work. <strong>Escape move:</strong> “Pick one control; run a friction audit; redesign.”`
  },
  {
    id:"s7",
    mode:"Transfer across domains",
    title:"Stage 7 — Adaptive: “Map the lattice onto new territory”",
    subtitle:"Learner enters unfamiliar domains and stays coherent by mapping levels + constraints.",
    where:"Level 1↔2↔3: super-concepts as transfer scaffolds",
    tags:["transfer", "navigation", "sensemaking"],
    focus:"sociotech",
    highlight:["sociotech","wai_wad","types_prob","seci","learning_memory","ecology_niches"],
    traceFor:["seci","learning_memory"],
    mindsetHtml:`<strong>Mobility increases.</strong> A small set of deep concepts scaffold new situations; the learner moves down into action without collapsing into vagueness or checklists.`,
    whatIf:[
      {q:"What if this is complex (not complicated)—what changes in how we intervene?", why:"Selects safe-to-fail + learning loops."},
      {q:"What if tacit judgement matters—how do we externalise carefully?", why:"Uses SECI without destroying craft."},
      {q:"What if a ‘keystone’ role disappears—what breaks first?", why:"Ecology reveals fragility."}
    ],
    socialHtml:`Meetings become integration events: tech, people, and compliance are linked rather than competing. The lattice provides shared language without flattening differences.`,
    stuckHtml:`<strong>Stuck pattern:</strong> people talk past each other (tech vs people vs compliance). <strong>Escape move:</strong> “Name the level you’re speaking from; then link levels.”`
  },
  {
    id:"s8",
    mode:"AI-era foresight",
    title:"Stage 8 — Foresight: “More possible actions → more consequence uncertainty”",
    subtitle:"Learner uses what-if as disciplined foresight under expanded action space.",
    where:"Across levels with explicit consequence mapping",
    tags:["foresight", "consequence", "governance"],
    focus:"tech_more_data",
    highlight:["tech_more_data","information","governanceInfo","trust_legit","purpose_conflict","wis_ethics"],
    traceFor:["governanceInfo","trust_legit"],
    mindsetHtml:`<strong>What-if becomes method.</strong> The learner anticipates second-order effects: trust erosion, perverse incentives, drift amplification, and accountability confusion—especially as AI increases what can be done.`,
    whatIf:[
      {q:"What if AI makes triage faster—who bears the risk of misclassification?", why:"Clarifies accountability + harm distribution."},
      {q:"What if monitoring increases—what happens to dignity and reporting?", why:"Trust underwrites sensing."},
      {q:"What if optimisation targets shift—what pathologies emerge?", why:"Purpose conflicts create failure modes."}
    ],
    socialHtml:`Meetings include consequence mapping: who changes behaviour, who is harmed, what backfires, and what we’ll monitor before rollout.`,
    stuckHtml:`<strong>Stuck pattern:</strong> “the model says…” replaces judgement. <strong>Escape move:</strong> governance first: consent, appeal, auditability, safe-to-fail deployment with rollback.`
  },
  {
    id:"s9",
    mode:"Wise motion + coordination",
    title:"Stage 9 — Expert: “Move fast across levels without losing the thread”",
    subtitle:"Expert keeps coherence under pressure: ethics, proportion, timing, and learning loops.",
    where:"Level 0↔all: wisdom guides movement",
    tags:["wisdom", "proportion", "safe-to-fail", "sensemaking"],
    focus:"wis_reflection",
    highlight:["wis_reflection","wis_listening","wis_grace","wis_proportion","wis_safe2fail","wis_holism","weakSignalsLoop"],
    traceFor:["wis_safe2fail","weakSignalsLoop"],
    mindsetHtml:`<strong>Coherence is stable.</strong> The expert shifts perspective (detail ↔ system ↔ values) while keeping a single through-line: what must hold, what is uncertain, and how to coordinate ethically.`,
    whatIf:[
      {q:"What if we are wrong—what reversible move teaches us fastest without harm?", why:"Safe-to-fail protects people and learning."},
      {q:"What if ‘success’ on one metric damages trust—how do we detect early?", why:"Trust underwrites sensing."},
      {q:"What if stakeholders disagree on purpose—how do we govern conflict?", why:"Makes values explicit and manageable."}
    ],
    socialHtml:`Meetings stop being decision theatre. The expert protects dignity, slows sensemaking briefly, then speeds action via a proportionate move plus monitoring.`,
    stuckHtml:`<strong>Stuck pattern:</strong> polarisation (ops vs safety vs HR). <strong>Escape move:</strong> listen, summarise each level, then propose one small experiment all can support.`
  }
];

/* =========================
   DOM refs
   ========================= */
const $ = (q, r=document) => r.querySelector(q);
const $$ = (q, r=document) => Array.from(r.querySelectorAll(q));

const levelsEl = $("#levels");
const edgesSvg = $("#edges");
const stageInner = $("#stageInner");

const timelineEl = $("#timeline");
const btnPlay = $("#btnPlay");
const btnPrev = $("#btnPrev");
const btnNext = $("#btnNext");
const stageCounter = $("#stageCounter");

const storyStageName = $("#storyStageName");
const storyMode = $("#storyMode");
const storyTitle = $("#storyTitle");
const storySubtitle = $("#storySubtitle");
const storyTags = $("#storyTags");
const storyWhere = $("#storyWhere");
const storyMindset = $("#storyMindset");
const storyWhatIf = $("#storyWhatIf");
const storySocial = $("#storySocial");
const storyStuck = $("#storyStuck");

const toastEl = $("#toast");

/* =========================
   State
   ========================= */
let selected = new Set();
let primary = null;
let edgeIndex = null;

let journeyIndex = 0;
let journeyPlaying = false;
let journeyTimer = null;
let journeyVisited = new Set();
let journeyActiveNodes = new Set();
let journeyActiveEdges = new Set();

/* Long-press multi-select */
let lpTimer = null;
let lpTargetId = null;
let lpFired = false;
const LONGPRESS_MS = 480;

function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  setTimeout(()=>toastEl.classList.remove("show"), 1200);
}

function cssEscape(s){
  return (window.CSS && CSS.escape) ? CSS.escape(s) : s.replace(/"/g,'\\"');
}

function kindTag(kind){
  if(kind==="wisdom") return "WISDOM";
  if(kind==="standard") return "STANDARD";
  if(kind==="case") return "CASE";
  if(kind==="risk") return "RISK";
  return "CONCEPT";
}

function buildEdgeIndex(){
  edgeIndex = { out:new Map(), into:new Map(), map:new Map() };
  for(const e of data.edges){
    if(!edgeIndex.out.has(e.from)) edgeIndex.out.set(e.from, []);
    if(!edgeIndex.into.has(e.to)) edgeIndex.into.set(e.to, []);
    edgeIndex.out.get(e.from).push(e);
    edgeIndex.into.get(e.to).push(e);
    edgeIndex.map.set(`${e.from}→${e.to}`, e);
  }
}

/* =========================
   Render lattice
   ========================= */
function render(){
  buildEdgeIndex();

  levelsEl.innerHTML = "";
  for(const lvl of data.levels){
    const wrap = document.createElement("section");
    wrap.className = "level";
    wrap.dataset.level = lvl.id;
    wrap.innerHTML = `
      <div class="levelHeader">
        <div class="lhTitle">
          <span class="badge">Level ${lvl.id}</span>
          <span>${lvl.title}</span>
        </div>
        <div class="lhHint">${lvl.hint}</div>
      </div>
      <div class="rowNodes" id="row-${lvl.id}"></div>
    `;
    levelsEl.appendChild(wrap);
  }

  const byLevel = new Map();
  for(const n of data.nodes){
    if(!byLevel.has(n.level)) byLevel.set(n.level, []);
    byLevel.get(n.level).push(n);
  }

  for(const [lvl, arr] of byLevel){
    arr.sort((a,b)=> (a.kind.localeCompare(b.kind) || a.label.localeCompare(b.label)));
    const row = $(`#row-${lvl}`);
    if(!row) continue;

    for(const n of arr){
      const nodeEl = document.createElement("div");
      nodeEl.className = "node";
      nodeEl.dataset.id = n.id;
      nodeEl.dataset.kind = n.kind;
      nodeEl.dataset.level = String(n.level);
      nodeEl.innerHTML = `
        <span class="dot"></span>
        <span class="label">${n.label}</span>
        <span class="tag">${kindTag(n.kind)}</span>
      `;

      // desktop pointerdown for modifiers
      nodeEl.addEventListener("pointerdown", (ev)=>{
        if(ev.pointerType === "touch") return;
        const multi = ev.shiftKey || ev.ctrlKey || ev.metaKey;
        selectNode(n.id, {multi});
        nodeEl.dataset.skipClick = "1";
      });

      nodeEl.addEventListener("click", (ev)=>{
        if(nodeEl.dataset.skipClick==="1"){ nodeEl.dataset.skipClick="0"; return; }
        if(lpFired){ lpFired = false; return; }
        const multi = ev.shiftKey || ev.ctrlKey || ev.metaKey;
        selectNode(n.id, {multi});
      });

      // touch long-press
      nodeEl.addEventListener("pointerdown", (ev)=>{
        if(ev.pointerType !== "touch") return;
        try{ nodeEl.setPointerCapture(ev.pointerId); }catch(_){}
        lpTargetId = n.id;
        lpFired = false;
        const sx = ev.clientX, sy = ev.clientY;
        nodeEl.dataset.lpStartX = String(sx);
        nodeEl.dataset.lpStartY = String(sy);
        clearTimeout(lpTimer);
        lpTimer = setTimeout(()=>{
          lpFired = true;
          selectNode(lpTargetId, {multi:true});
          toast("Multi-select toggled");
        }, LONGPRESS_MS);
      });

      nodeEl.addEventListener("pointermove", (ev)=>{
        if(ev.pointerType !== "touch") return;
        if(!lpTimer) return;
        const sx = Number(nodeEl.dataset.lpStartX || "0");
        const sy = Number(nodeEl.dataset.lpStartY || "0");
        if(Math.hypot(ev.clientX - sx, ev.clientY - sy) > 10){
          clearTimeout(lpTimer);
          lpTimer = null;
        }
      });

      nodeEl.addEventListener("pointerup", (ev)=>{
        if(ev.pointerType !== "touch") return;
        if(lpTimer){ clearTimeout(lpTimer); lpTimer = null; }
        if(lpFired) ev.preventDefault();
      });

      nodeEl.addEventListener("pointercancel", ()=>{
        if(lpTimer){ clearTimeout(lpTimer); lpTimer = null; }
      });

      row.appendChild(nodeEl);
    }
  }

  requestAnimationFrame(()=>{
    drawEdges();
    renderTimeline();
    applyJourneyStep(0, {scrollLattice:true, silent:true});
  });
}

function drawEdges(){
  edgesSvg.innerHTML = "";

  const rect = stageInner.getBoundingClientRect();
  edgesSvg.setAttribute("viewBox", `0 0 ${rect.width} ${rect.height}`);

  const centers = new Map();
  for(const nodeEl of $$(".node", stageInner)){
    const r = nodeEl.getBoundingClientRect();
    const cx = (r.left - rect.left) + r.width/2;
    const cy = (r.top - rect.top) + r.height/2;
    centers.set(nodeEl.dataset.id, {cx, cy});
  }

  for(const e of data.edges){
    const a = centers.get(e.from);
    const b = centers.get(e.to);
    if(!a || !b) continue;

    const dx = (b.cx - a.cx);
    const dy = (b.cy - a.cy);
    const bend = Math.max(42, Math.abs(dy)*0.35);
    const c1x = a.cx + dx*0.15;
    const c1y = a.cy + (dy>=0 ? bend : -bend);
    const c2x = b.cx - dx*0.15;
    const c2y = b.cy - (dy>=0 ? bend : -bend);

    const p = document.createElementNS("http://www.w3.org/2000/svg","path");
    p.setAttribute("d", `M ${a.cx} ${a.cy} C ${c1x} ${c1y}, ${c2x} ${c2y}, ${b.cx} ${b.cy}`);
    p.setAttribute("class", "edge");
    p.dataset.from = e.from;
    p.dataset.to = e.to;
    edgesSvg.appendChild(p);
  }

  highlightEdges();
}

/* =========================
   Selection / edges
   ========================= */
function selectNode(id, {multi=false}={}){
  if(!multi){
    selected.clear();
    selected.add(id);
  }else{
    if(selected.has(id)) selected.delete(id);
    else selected.add(id);
  }
  primary = selected.size ? (selected.has(id) ? id : selected.values().next().value) : null;
  applySelectionStyles();
  highlightEdges();
}

function clearSelection(){
  selected.clear();
  primary = null;
  applySelectionStyles();
  highlightEdges();
}

function applySelectionStyles(){
  for(const nodeEl of $$(".node", stageInner)){
    nodeEl.classList.toggle("selected", selected.has(nodeEl.dataset.id));
  }
}

function highlightEdges(){
  const hi = new Set();

  if(edgeIndex && selected && selected.size){
    for(const sid of selected){
      for(const e of (edgeIndex.out.get(sid)||[])) hi.add(`${e.from}→${e.to}`);
      for(const e of (edgeIndex.into.get(sid)||[])) hi.add(`${e.from}→${e.to}`);
    }
  }

  const stageSet = journeyActiveEdges || new Set();

  for(const p of $$(".edge", edgesSvg)){
    const key = `${p.dataset.from}→${p.dataset.to}`;
    const shouldHi = hi.has(key);
    const shouldStage = stageSet.has(key);

    p.classList.toggle("stage", shouldStage);
    p.classList.toggle("hi", shouldHi && !shouldStage);

    const anyEmphasis = (selected.size>0 || stageSet.size>0);
    const isEmph = shouldStage || shouldHi;
    p.classList.toggle("dim", anyEmphasis && !isEmph);
  }
}

function applyJourneyNodeStyles(){
  for(const nodeEl of $$(".node", stageInner)){
    nodeEl.classList.remove("stageActive","stageVisited","stageDim");
  }
  for(const nodeEl of $$(".node", stageInner)) nodeEl.classList.add("stageDim");

  const visitedNodes = new Set();
  for(const sid of journeyVisited){
    const st = JOURNEY.find(x=>x.id===sid);
    if(st?.highlight) for(const nid of st.highlight) visitedNodes.add(nid);
  }
  for(const nid of visitedNodes){
    const nodeEl = $(`.node[data-id="${cssEscape(nid)}"]`, stageInner);
    if(nodeEl){
      nodeEl.classList.remove("stageDim");
      nodeEl.classList.add("stageVisited");
    }
  }

  for(const nid of journeyActiveNodes){
    const nodeEl = $(`.node[data-id="${cssEscape(nid)}"]`, stageInner);
    if(nodeEl){
      nodeEl.classList.remove("stageDim");
      nodeEl.classList.add("stageActive");
    }
  }

  highlightEdges();
}

/* =========================
   Journey mechanics
   ========================= */
function findTopRoots(){
  return data.nodes.filter(n=>n.level===0).map(n=>n.id);
}

function traceToTop(targetId){
  const roots = new Set(findTopRoots());
  if(roots.has(targetId)) return [targetId];

  const q = [targetId];
  const prev = new Map();
  const seen = new Set([targetId]);
  let foundRoot = null;

  while(q.length){
    const cur = q.shift();
    const incoming = edgeIndex.into.get(cur) || [];
    for(const e of incoming){
      const up = e.from;
      if(seen.has(up)) continue;
      seen.add(up);
      prev.set(up, cur);
      if(roots.has(up)){ foundRoot = up; q.length = 0; break; }
      q.push(up);
    }
  }
  if(!foundRoot) return [targetId];

  const path = [foundRoot];
  let cur = foundRoot;
  while(cur !== targetId){
    const next = prev.get(cur);
    if(!next) break;
    path.push(next);
    cur = next;
  }
  return path;
}

function computeJourneyEdgesFor(nodes, traceIds){
  const keys = new Set();

  for(const tid of traceIds){
    const path = traceToTop(tid);
    if(path && path.length>1){
      for(let i=0;i<path.length-1;i++){
        keys.add(`${path[i]}→${path[i+1]}`);
      }
    }
  }

  for(const a of nodes){
    for(const e of (edgeIndex.out.get(a)||[])){
      if(nodes.has(e.to)) keys.add(`${e.from}→${e.to}`);
    }
    for(const e of (edgeIndex.into.get(a)||[])){
      if(nodes.has(e.from)) keys.add(`${e.from}→${e.to}`);
    }
  }

  return keys;
}

/* =========================
   Timeline (no subheadings in cards)
   ========================= */
function renderTimeline(){
  timelineEl.innerHTML = "";
  for(let i=0;i<JOURNEY.length;i++){
    const st = JOURNEY[i];
    const item = document.createElement("div");
    item.className = "tStep";
    item.dataset.i = String(i);
    item.innerHTML = `
      <div class="tTop">
        <div class="tNum">${i+1}</div>
        <div class="pill purple" style="margin-left:auto">${st.mode}</div>
      </div>
      <div class="tTitle">${st.title.replace(/^Stage \\d+ — /,"")}</div>
    `;
    item.onclick = ()=> applyJourneyStep(i, {scrollLattice:true});
    timelineEl.appendChild(item);
  }
  updateTimelineUI({scrollIntoView:false});
}

function updateTimelineUI({scrollIntoView=true}={}){
  const items = $$(".tStep", timelineEl);
  for(const item of items){
    const i = Number(item.dataset.i);
    item.classList.toggle("active", i===journeyIndex);
    item.classList.toggle("done", i<journeyIndex);
  }

  btnPrev.disabled = journeyIndex===0;
  btnNext.disabled = journeyIndex===JOURNEY.length-1;
  btnPlay.textContent = journeyPlaying ? "Pause" : "Play";

  const st = JOURNEY[journeyIndex];
  stageCounter.textContent = `Stage ${journeyIndex+1} / ${JOURNEY.length} • ${st.mode}`;

  if(scrollIntoView){
    const active = $(`.tStep[data-i="${journeyIndex}"]`, timelineEl);
    active?.scrollIntoView({behavior:"smooth", inline:"center", block:"nearest"});
  }
}

function renderStageStory(){
  const st = JOURNEY[journeyIndex];

  storyStageName.textContent = `Stage ${journeyIndex+1}`;
  storyMode.textContent = st.mode;

  storyTitle.textContent = st.title;
  storySubtitle.textContent = st.subtitle;

  storyTags.innerHTML = "";
  for(const t of (st.tags || [])){
    const p = document.createElement("div");
    p.className = "pill";
    p.textContent = t;
    storyTags.appendChild(p);
  }

  storyWhere.textContent = st.where || "—";
  storyMindset.innerHTML = st.mindsetHtml || "";

  storyWhatIf.innerHTML = "";
  for(const item of (st.whatIf || [])){
    const div = document.createElement("div");
    div.className = "qItem";
    div.innerHTML = `<div class="q">${item.q}</div><div class="why">${item.why}</div>`;
    storyWhatIf.appendChild(div);
  }

  storySocial.innerHTML = st.socialHtml || "";
  storyStuck.innerHTML = st.stuckHtml || "";
}

function scrollToNode(id){
  const nodeEl = $(`.node[data-id="${cssEscape(id)}"]`, stageInner);
  if(!nodeEl) return;
  nodeEl.scrollIntoView({behavior:"smooth", block:"center", inline:"center"});
}

function applyJourneyStep(i, {scrollLattice=false, silent=false}={}){
  journeyIndex = Math.max(0, Math.min(JOURNEY.length-1, i));
  const st = JOURNEY[journeyIndex];

  journeyVisited.add(st.id);
  journeyActiveNodes = new Set(st.highlight || []);
  journeyActiveEdges = computeJourneyEdgesFor(
    journeyActiveNodes,
    new Set([st.focus, ...(st.traceFor||[])])
  );

  applyJourneyNodeStyles();
  renderStageStory();
  updateTimelineUI({scrollIntoView:true});

  if(scrollLattice && st.focus) scrollToNode(st.focus);

  if(!selected.size && st.focus){
    selectNode(st.focus, {multi:false});
  }else{
    highlightEdges();
  }

  if(!silent) toast(`Stage ${journeyIndex+1}`);
}

function playJourney(){
  if(journeyPlaying) return;
  journeyPlaying = true;
  btnPlay.textContent = "Pause";

  journeyTimer = setInterval(()=>{
    if(journeyIndex >= JOURNEY.length-1){
      pauseJourney();
      return;
    }
    applyJourneyStep(journeyIndex+1, {scrollLattice:true, silent:true});
  }, 3800);

  toast("Playing");
}

function pauseJourney(){
  journeyPlaying = false;
  btnPlay.textContent = "Play";
  if(journeyTimer){ clearInterval(journeyTimer); journeyTimer = null; }
  toast("Paused");
}

/* =========================
   Wire controls
   ========================= */
btnPlay.onclick = ()=> { journeyPlaying ? pauseJourney() : playJourney(); };
btnPrev.onclick = ()=> applyJourneyStep(journeyIndex-1, {scrollLattice:true});
btnNext.onclick = ()=> applyJourneyStep(journeyIndex+1, {scrollLattice:true});

window.addEventListener("resize", ()=>{ drawEdges(); });

document.addEventListener("keydown", (ev)=>{
  if(ev.key==="Escape") clearSelection();
});

/* =========================
   Boot
   ========================= */
render();
</script>
</body>
</html>
